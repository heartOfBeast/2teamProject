<!doctype html>
<html
	xmlns:th="http://www.thymeleaf.org"
 	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="@{layout/default}">
<th:block layout:fragment="pageTitle">
<div class="page-header">
	<ol class="breadcrumb">
		<li class="breadcrumb-item">재무관리</li>
		<li class="breadcrumb-item active">지출내역조회</li>
	</ol>

	<ul class="app-actions">
		<li>
			<a href="#" id="reportrange">
				<span class="range-text"></span>
				<i class="icon-chevron-down"></i>	
			</a>
		</li>
		<li>
			<a href="#">
				<i class="icon-export"></i>
			</a>
		</li>
	</ul>
</div>

<th:block layout:fragment="container">
<div class="main-container">
	<div class="row gutters">
							<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

					
							<div class="card">
								<div class="card-header">
									<div class="card-title">21년 지출현황(그래프)</div>
								</div>
								<div class="card-body">
									<div id="basic-column-stack-graph-fullheight2" class="primary-graph"></div>
								</div>
							</div>

					

						</div>
				
					<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
							
						<div class="table-container">
							<div class="t-header">21년 지출현황(표)</div>
								<div class="table-responsive">
									<table id="copy-print-csv" class="table custom-table">
										<thead>
											<tr>
												<th>
									  		<input type="checkbox" id="expenseCheckAll" style="position: relative; top: 1.5px;">
									  			</th>
												<th>지출코드</th>
												<th>지출내역</th>
												<th>지출날짜</th>
												<th>현금카드</th>
												<th>카드정보</th>
												<th>매장명</th>
												<th>종류</th>
												<th>금액</th>
												<th>등록자</th>
												<th>등록일</th>
												<th>수정</th>
											
											</tr>
										</thead>
										<tbody>
											<tr th:each="L :${expenditureList}">
												 <td>
								  	  	<input type="checkbox" class="expenseCheckOne" style="position: relative; top: 1.5px;" th:value="${L.expenseCode}">
									  			</td>
												<td th:text ="${L.expenseCode}"></td>
												<td th:text ="${L.expenseInfo}"></td>
												<td th:text ="${L.expenseDate}"></td>
												<td th:text ="${L.expenseCashCard}"></td>
												<td th:text ="${L.expenseCardInfo}"></td>
												<td th:text ="${L.expenseStore}"></td>
												<td id="cate" th:text ="${L.expenseCate}"></td>
												<td id="pay" th:text ="${L.expensePayment}"></td>
												<td th:text ="${L.wareadminId}"></td>
												<td th:text ="${L.expensRegDate}"></td>
												<td></td>
											
											</tr>
										</tbody>
									</table>
								<button type="button" class="btn btn-primary float-right" onclick="deleteDate();">삭제</button>
									
							</div>
							</div>
					</div>
	</div>
</div>
</th:block>

<th:block layout:fragment="customJs">
	<script th:inline="javascript">
	
			/*******************************그래프양식(?)******************************************/
	window.onload = function(){
		
	var options = {
		  chart:	 	{
		    				height: 350,
		    				type: 'bar',
		    				stacked: true,
		    				stackType: '100%',
		   					toolbar: {
		      				show: false
		    				},
		    				zoom: {
		      				enabled: true
		    				}
		  				},
		 responsive: 	[{
		    				breakpoint: 480,
		    				options: {
		      				legend: {
		        			position: 'bottom',
		        			offsetX: -10,
		        			offsetY: 0
		     			    }
		    			}
		  				}],
		plotOptions: 	{
		    				bar: {
		      				horizontal: false,
		    				},
		  				},
		dataLabels: 	{
		    				enabled: true
		  				},
		  
		series: 		[{
		    				name: '식료품',
		    				data: [foodPercent]
		  				},{
		    				name: '비품',
		    				data: [equipPercent]
		  				},{
						    name: '임금',
						    data: [wagePercent]
					    },{
						    name: '생필품',
						    data: [necessityPercent]
					 	}],	
		  xaxis: 		{
						    type: 'datetime',
						    categories: ['01/01/2021 GMT', '02/01/2021 GMT', '03/01/2021 GMT', '04/01/2021 GMT', '05/01/2021 GMT', '06/01/2021 GMT'
						    			,'07/01/2021 GMT', '08/01/2021 GMT', '09/01/2021 GMT', '10/01/2021 GMT', '11/01/2021 GMT', '12/01/2021 GMT','01/01/2022 GMT'],
				  		},
		  legend: 		{
						    position: 'top',
						    offsetY: 10
		  				},
		  fill: 		{
						    opacity: 1
						},
		  colors: 		['#FE2E2E', '#2EFE64', '#DA81F5', '#81F7F3'],
						}
	
		var chart2 = new ApexCharts(
		  document.querySelector("#basic-column-stack-graph-fullheight2"),
		  options
		);
		chart2.render();
		}
	/********************************위에꺼 계산식***************************************/
		
	/*<![CDATA[*/
		var result =/*[[${expenditureList}]]*/;
	/*]]>*/
		var SumPrice =0;
		var Percent = 0;
		var food = '식료품';
		var equip = '비품';
		var wage = '임금';
		var necessity = '생필품';
		var foodSumPrice = 0;
		var equipSumPrice = 0;
		var wageSumPrice = 0;
		var necessitySumPrice = 0;
		var foodPercent = 0;
		var equipPercent = 0;
		var wagePercent = 0;
		var necessityPercent = 0;
		var totalPrice = 0;
		var FinalTotalPrice = 0;
		
	for(i=0; i<result.length; i++){
		var exCate = result[i].expenseCate
		var exDate = result[i].expenseDate
		totalPrice += parseInt(result[i].expensePayment);
		
		if(exDate.substring(0,7) ==  '2021-01' && exCate == food){
			foodSumPrice += parseInt(result[i].expensePayment);
			
		}else if (exDate.substring(0,7) == '2021-01' && exCate == equip){
			equipSumPrice += parseInt(result[i].expensePayment);
	
		}else if (exDate.substring(0,7) == '2021-01' && exCate == wage){
			wageSumPrice += parseInt(result[i].expensePayment);
			
		}else if (exDate.substring(0,7) == '2021-01' && exCate == necessity){
			necessitySumPrice += parseInt(result[i].expensePayment);
			
		} 
	}
	
			foodPercent = Math.floor((foodSumPrice/totalPrice) * 100);
			equipPercent = Math.floor((equipSumPrice/totalPrice) * 100);
			wagePercent = Math.floor((wageSumPrice/totalPrice) * 100);
			necessityPercent = 100 - foodPercent - equipPercent - wagePercent ;  
// 			necessityPercent = (necessitySumPrice/totalPrice) * 100


	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	/**********************************************************************************/
			$(function(){
				$('#expenseCheckAll').click(function(){
					if($('#expenseCheckAll').prop('checked')){
						$('.expenseCheckOne').prop('checked', true);
					}else{
						$('.expenseCheckOne').prop('checked', false);
					}
				})
			})
			function deleteDate(){
				var dataArr = new Array();
				var list = $('.expenseCheckOne');
				for(var i=0; i<list.length; i++){
					if(list[i].checked){
						dataArr.push(list[i].value);
					}
				}
				if(dataArr.length == 0){
					alert('삭제할 항목을 선택해주세요.');
				}
				else{
					var chk = confirm('정말 삭제하시겠습니까?');
					if(chk){
						$.ajax({
							url : "/expenditureDelete",
							method : 'post',
							async : true,
							dataType : "json",
							data : {'dataArr':dataArr},
							success: function(jdata){
								if(jdata != 1){
									alert('오류 : 삭제 실패');
								}else{
									alert('삭제 되었습니다.');
									location.replace("expenditure");
								}
							}
				    	});
					}else{
						return false;
					}
						
					
				}
			}
			
	</script>

		
</html>